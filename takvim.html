<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takvim | Finansal Özet</title>

    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/notifications.css">

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <style>
        /* Calendar Overrides for Mobile */
        .fc-header-toolbar {
            font-size: 0.9rem;
            flex-direction: column;
            gap: 0.5rem;
        }

        @media (min-width: 640px) {
            .fc-header-toolbar {
                flex-direction: row;
            }
        }

        .fc {
            background: var(--color-bg-card);
            padding: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .fc .fc-button-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .fc-event {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <header>
        <div class="container header-content">
            <div class="flex items-center gap-4">
                <a href="index.html" class="btn-icon" style="background-color: var(--color-bg-body);">
                    <span class="material-symbols-outlined">arrow_back</span>
                </a>
                <h1 style="font-size: 1.5rem; font-weight: 800;">Takvim</h1>
            </div>
        </div>
    </header>

    <main class="container py-8">

        <!-- Legend -->
        <div class="flex gap-4 mb-4 justify-center">
            <div class="flex items-center gap-2">
                <div style="width:0.75rem; height:0.75rem; background: var(--color-success); border-radius:50%"></div>
                <span class="text-sm">Gelir</span>
            </div>
            <div class="flex items-center gap-2">
                <div style="width:0.75rem; height:0.75rem; background: var(--color-error); border-radius:50%"></div>
                <span class="text-sm">Gider</span>
            </div>
            <div class="flex items-center gap-2">
                <div style="width:0.75rem; height:0.75rem; background: var(--color-warning); border-radius:50%"></div>
                <span class="text-sm">Fatura</span>
            </div>
        </div>

        <div id='calendar'></div>
    </main>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content card">
            <div class="modal-header">
                <h2 id="event-title" style="font-size: 1.5rem; font-weight: 800;">Detay</h2>
                <button onclick="closeEventModal()" class="btn-icon">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="py-4">
                <p id="event-date" class="text-secondary mb-2">Tarih</p>
                <p id="event-amount" style="font-size: 2rem; font-weight: 900;">₺0,00</p>
                <p id="event-category" class="mt-2 tag">Kategori</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            var calendarEl = document.getElementById('calendar');

            // 1. Fetch Data
            let events = [];
            try {
                // Fetch Transactions
                const resT = await fetch('/api/transactions?limit=200');
                const dataT = await resT.json();

                // Fetch Debts for Calendar Projection
                const resD = await fetch('/api/debts');
                const dataD = await resD.json();

                // Process Transactions
                events = dataT.map(item => {
                    let color = '#d32f2f'; // Error/Red for expense
                    if (item.type === 'income') color = '#2e7d32'; // Success/Green
                    if (item.is_recurring) color = '#ed6c02'; // Warning/Orange

                    const amountStr = item.amount.toLocaleString('tr-TR', { maximumFractionDigits: 0 });

                    return {
                        title: `${item.title} (${amountStr}₺)`,
                        start: item.date,
                        allDay: true,
                        backgroundColor: color,
                        borderColor: color,
                        extendedProps: {
                            amount: item.amount,
                            category: item.category,
                            type: item.type
                        }
                    };
                });

                // Process Loans & Cards
                const today = new Date();
                dataD.forEach(debt => {
                    if (debt.type === 'loan' && debt.remaining_installments > 0) {
                        let currentMonth = today.getMonth();
                        let currentYear = today.getFullYear();

                        // Let's project 24 months forward for now or remaining installments
                        const count = Math.min(debt.remaining_installments, 24);

                        for (let i = 0; i < count; i++) {
                            // Logic: Always project starting from NEXT due date relative to today?
                            // Or simplify: Project for THIS month (if future) + next X months.

                            // Let's keep it simple: Project from THIS month based on due day.
                            // If due day passed in this month, user might have paid or missed.
                            // But showing it in past on calendar is fine/good.

                            let targetMonth = currentMonth + i;
                            let yearOffset = Math.floor(targetMonth / 12);
                            let monthIndex = targetMonth % 12;

                            let eventDate = new Date(currentYear + yearOffset, monthIndex, debt.due_date_day);

                            events.push({
                                title: `${debt.name} (${i + 1}/${debt.total_installments})`,
                                start: eventDate.toISOString().split('T')[0],
                                allDay: true,
                                backgroundColor: '#9c27b0', // Purple for Loans
                                borderColor: '#9c27b0',
                                extendedProps: {
                                    amount: debt.monthly_payment,
                                    category: 'Kredi Taksiti',
                                    type: 'loan_payment'
                                }
                            });
                        }
                    } else if (debt.type === 'credit_card') {
                        // Project next 12 months due dates? Or just next one?
                        // User said "Son ödeme tarihini ekle". Typically recurring.
                        // Let's project 6 months ahead for cards to be helpful.

                        let currentMonth = today.getMonth();
                        let currentYear = today.getFullYear();

                        for (let i = 0; i < 6; i++) {
                            let targetMonth = currentMonth + i;
                            let yearOffset = Math.floor(targetMonth / 12);
                            let monthIndex = targetMonth % 12;

                            let eventDate = new Date(currentYear + yearOffset, monthIndex, debt.due_date_day);

                            events.push({
                                title: `${debt.name} Ekstre`,
                                start: eventDate.toISOString().split('T')[0],
                                allDay: true,
                                backgroundColor: '#e91e63', // Pink for Cards
                                borderColor: '#e91e63',
                                extendedProps: {
                                    amount: debt.total_amount, // Shows CURRENT debt amount each month (approx)
                                    category: 'Kredi Kartı',
                                    type: 'card_payment'
                                }
                            });
                        }
                    }
                });

            } catch (e) {
                console.error("Calendar fetch error", e);
            }

            // 2. Init Calendar
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'tr',
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'dayGridMonth,listWeek'
                },
                buttonText: {
                    today: 'Bugün',
                    month: 'Ay',
                    list: 'Liste'
                },
                events: events,
                eventClick: function (info) {
                    showEventDetails(info.event);
                },
                height: 'auto'
            });

            calendar.render();
        });

        function showEventDetails(event) {
            document.getElementById('event-title').innerText = event.title.split('(')[0].trim(); // Remove amount from title

            const dateStr = event.start.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('event-date').innerText = dateStr;

            const amount = event.extendedProps.amount;
            const type = event.extendedProps.type;
            const color = type === 'income' ? 'var(--color-success)' : 'var(--color-error)';
            const prefix = type === 'income' ? '+' : '-';

            const amountEl = document.getElementById('event-amount');
            amountEl.innerText = `${prefix}₺${amount.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}`;
            amountEl.style.color = color;

            document.getElementById('event-category').innerText = event.extendedProps.category;

            document.getElementById('event-modal').classList.remove('hidden');
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.add('hidden');
        }

        // Close modal on backdrop click
        document.querySelector('.modal-backdrop').addEventListener('click', closeEventModal);
    </script>
</body>

</html>